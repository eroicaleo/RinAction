---
title: "XGBoostTitanic"
author: "Yang Ge"
date: "8/13/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(xgboost)
require(tidyverse)
require(Matrix)
set.seed(20121228)
train <- read.csv("train.csv")
test <- read.csv("test.csv")
str(train)
```

# Try to convert just the "Sex" column to matrix

* We can see that no matter how to change the `nrounds`, the train error stays the same.
* My 1st step is to find out how to link the leaf and prediction number in debug mode.

```{r}
is_female <- as.numeric(train$Sex) - 1
is_female_m <- as.matrix(is_female)
# str(is_female_m)
dtrain <- xgb.DMatrix(data = is_female_m, label = train$Survived)
# str(dtrain)
bstDMatrix_02 <- xgboost(data = dtrain, max.depth = 2,
                     eta = 1, nthread = 2, nrounds = 1, objective = "binary:logistic")
# bstDMatrix_10 <- xgboost(data = dtrain, max.depth = 2,
#                      eta = 1, nthread = 2, nrounds = 10, objective = "binary:logistic")

# xgb.plot.tree(model = bstDMatrix_02)

xgb.dump(bstDMatrix_02, with_stats = TRUE)

pred <- predict(bstDMatrix_02, is_female_m)
pred[pred <= 0.5] <- 0
pred[pred > 0.5] <- 1
compare <- cbind(is_female_m, train$Survived, pred)
which(pred != train$Survived)
```

# Next, try to convert the "Sex" and "Pclass" to matrix

* Note that no `NA` is in the pclass
* I would like to find out whether make it a normal matrix or a sparse matrix would make
  any difference

```{r}
pclass <- train$Pclass - 1
sex_pclass <- as.matrix(cbind(is_female, pclass))

v <- pclass
m <- numeric(length(v))
m[v == 0] <- 1
for (i in seq(1 + min(v), max(v))) {
  m0 <- numeric(length(v))
  m0[v == i] <- 1
  m <- cbind(m, m0)
}
m_matrix <- as.matrix(m)
colnames(m_matrix) <- c("P0", "P1", "P2")
sex_pclass <- cbind(is_female, m_matrix)
dtrain <- xgb.DMatrix(data = sex_pclass, label = train$Survived)
bstDMatrix_sex_pclass <- xgboost(data = dtrain, max.depth = 3,
                     eta = 0.1, nthread = 2, nrounds = 2, objective = "binary:logistic")

# important_matrix <- xgb.importance(model = bstDMatrix_02)
# print(important_matrix)
# xgb.plot.importance(importance_matrix = important_matrix)

xgb.dump(bstDMatrix_sex_pclass, with_stats = TRUE)
```

```{r}
pred_pclass <- predict(bstDMatrix_sex_pclass, sex_pclass)
pred_pclass[pred_pclass < 0.5] <- 0
pred_pclass[pred_pclass >= 0.499] <- 1
compare_pclass <- cbind(train$Survived, pred_pclass)
which(pred_pclass != train$Survived)
```

* It looks to me that the `nrounds` (even to 1000) and `max.depth` doesn't really change the tree
  structure. It's always use `Sex` as the top splitting node and the `Pclass` doesn't really
  matters.
* One interesting observation is that the tree generated by `nrounds = 1`, the node 4 is 0.
  which means a data in this category (female in Pclass 3) has an equal chance of Survived and Died.
  with the following code, we can see the number is 72/72.
  
```{r}
survived_sex_pclass <- train %>%
  group_by(Survived, Sex, Pclass) %>%
  count()
```

* I would like to see, if it's worth to improve accuracy for women in this category.

```{r}
test_female_Pclass3 <- test %>%
  filter(Sex == "female", Pclass == 3)
nrow(test_female_Pclass3) / nrow(test)
```

* As shown below, if I can predict it perfect in this category, I might be able to increase
  accuracy by 8%. Let's do it.
  
```{r}
train_female_Pclass3 <- train %>%
  filter(Sex == "female", Pclass == 3)
nrow(train_female_Pclass3) / nrow(train)
```

* I would like to explore a bit the `Survived` with `Age, Sibsp, Parch, Fare, Embarked`

```{r}
sum(is.na(train_female_Pclass3$SibSp))
sum(is.na(train_female_Pclass3$Parch))
sum(is.na(train_female_Pclass3$Embarked))
```

* We can see there are no `NA` in `Sibsp, Parch, Embarked`, let's do some plot for them.

```{r}
ggplot(data = train_female_Pclass3) +
  geom_count(mapping = aes(x = SibSp, y = Survived))
ggplot(data = train_female_Pclass3) +
  geom_count(mapping = aes(x = Parch, y = Survived))
ggplot(data = train_female_Pclass3) +
  geom_count(mapping = aes(x = Embarked, y = Survived))
```

* Let's throw them in the xgboost

```{r}
tmp <- tbl_df(train_female_Pclass3)
m_matrix <- cbind(as.numeric(train_female_Pclass3$SibSp), as.numeric(train_female_Pclass3$Parch))
class(m_matrix[,2])
dim(m_matrix)

dtrain <- xgb.DMatrix(data = m_matrix, label = train_female_Pclass3$Survived)
bstDMatrix_female_Pclass3 <- xgboost(data = dtrain, max.depth = 2,
                     eta = 0.1, nthread = 2, nrounds = 2, objective = "binary:logistic")
xgb.dump(bstDMatrix_female_Pclass3, with_stats = TRUE)
```




